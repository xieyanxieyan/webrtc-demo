{"code":"(window[\"webpackJsonp\"]=window[\"webpackJsonp\"]||[]).push([[\"chunk-97c10518\"],{\"2add\":function(t,e,i){\"use strict\";i(\"9cc0\")},\"3ab1\":function(t,e,i){\"use strict\";i.r(e);var s=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i(\"div\",{directives:[{name:\"loading\",rawName:\"v-loading\",value:t.loading,expression:\"loading\"}],staticClass:\"remote1\",attrs:{\"element-loading-text\":t.loadingText,\"element-loading-spinner\":\"el-icon-loading\",\"element-loading-background\":\"rgba(0, 0, 0 , 0.7)\"}},[t.isJoin?t._e():i(\"div\",{staticClass:\"shade\"},[i(\"div\",{staticClass:\"input-container\"},[i(\"el-input\",{staticClass:\"input-account\",attrs:{type:\"text\",size:\"middle\",placeholder:\"请输入昵称\",\"keyup.enter\":\"join\"},model:{value:t.account,callback:function(e){t.account=e},expression:\"account\"}}),i(\"el-button\",{attrs:{size:\"middle\"},on:{click:t.join}},[t._v(\"确定\")])],1)]),i(\"div\",{staticClass:\"userList\"},[i(\"h5\",[t._v(\"在线用户: \"+t._s(t.userList.length))]),t._l(t.userList,(function(e){return i(\"p\",{key:e.count},[t._v(\"\\n          \"+t._s(e.account)+\"\\n          \"),e.account===t.account||e.account===t.isCall?i(\"i\",[t._v(\"\\n              \"+t._s(e.account===t.account?\"me\":\"\")+\"\\n              \"+t._s(e.account===t.isCall?\"calling\":\"\")+\"\\n          \")]):t._e(),e.account!==t.account&&e.account!==t.isCall?i(\"span\",{on:{click:function(i){return t.apply(e.account)}}},[t._v(\"呼叫\"+t._s(e.account))]):t._e()])}))],2),i(\"div\",{staticClass:\"video-container\"},[i(\"div\",[i(\"ul\",t._l(t.handleList,(function(e){return i(\"li\",{key:e.type},[\"color\"===e.type?i(\"el-color-picker\",{attrs:{\"show-alpha\":\"\",disabled:!t.isToPeer},on:{change:t.colorChange},model:{value:t.color,callback:function(e){t.color=e},expression:\"color\"}}):t._e(),[\"color\",\"lineWidth\",\"polygon\"].includes(e.type)?t._e():i(\"button\",{class:{active:t.currHandle===e.type},attrs:{disabled:\"cancel\"===e.type?!t.isToPeer||t.allowCancel:\"go\"===e.type?!t.isToPeer||t.allowGo:!t.isToPeer},on:{click:function(i){return t.handleClick(e)}}},[t._v(\"\\n                      \"+t._s(e.name)+\"\\n              \")]),\"polygon\"===e.type?i(\"el-popover\",{attrs:{placement:\"top\",width:\"400\",trigger:\"click\"}},[i(\"el-input-number\",{attrs:{\"controls-position\":\"right\",min:3,max:10},on:{change:t.sidesChange},model:{value:t.sides,callback:function(e){t.sides=e},expression:\"sides\"}}),i(\"button\",{class:{active:t.currHandle===e.type},attrs:{slot:\"reference\",disabled:!t.isToPeer},on:{click:function(i){return t.handleClick(e)}},slot:\"reference\"},[t._v(t._s(e.name))])],1):t._e(),\"lineWidth\"===e.type?i(\"el-popover\",{attrs:{placement:\"top\",width:\"400\",trigger:\"click\"}},[i(\"el-slider\",{attrs:{max:20},on:{change:t.lineWidthChange},model:{value:t.lineWidth,callback:function(e){t.lineWidth=e},expression:\"lineWidth\"}}),i(\"button\",{attrs:{slot:\"reference\",disabled:!t.isToPeer},slot:\"reference\"},[t._v(t._s(e.name)+\" \"),i(\"i\",[t._v(t._s(t.lineWidth+\"px\"))])])],1):t._e()],1)})),0),i(\"div\",[i(\"h5\",[t._v(\"画板\")]),i(\"canvas\",{ref:\"canvas\",attrs:{width:\"400\",height:\"500\"}})])]),i(\"div\",[i(\"h5\",[t._v(\"聊天\")]),i(\"div\",{staticClass:\"chat\"},[t._l(t.messageList,(function(e,s){return i(\"div\",{key:s,staticClass:\"message\"},[i(\"p\",[t._v(\"\\n                      \"+t._s(e.account)+\" - \"+t._s(e.time)+\"\\n                  \")]),i(\"p\",{staticClass:\"mes\"},[t._v(t._s(e.mes))])])})),i(\"textarea\",{directives:[{name:\"model\",rawName:\"v-model\",value:t.sendText,expression:\"sendText\"}],domProps:{value:t.sendText},on:{input:function(e){e.target.composing||(t.sendText=e.target.value)}}}),i(\"br\"),i(\"button\",{attrs:{disabled:!t.isToPeer},on:{click:function(e){return t.send([\"text\"])}}},[t._v(\"发送\")])],2)])])])},a=[],n=i(\"29b2\");class o{constructor(t,{drawType:e=\"line\",drawColor:i=\"rgba(19, 206, 102,c1)\",lineWidth:s=5,sides:a=3,allowCallback:n,moveCallback:o}){this.canvas=t,this.width=t.width,this.height=t.height,this.paint=t.getContext(\"2d\"),this.isClickCanvas=!1,this.imgData=[],this.isMoveCanvas=!1,this.index=0,this.x=0,this.y=0,this.last=[this.x,this.y],this.drawType=e,this.drawColor=i,this.lineWidth=s,this.sides=a,this.allowCallback=n||function(){},this.moveCallback=o||function(){},this.bindMousemove=function(){},this.bindMousedown=function(){},this.bindMouseup=function(){},this.init()}init(){this.paint.fillStyle=\"#fff\",this.paint.fillRect(0,0,this.width,this.height),this.gatherImage(),this.bindMousemove=this.onmousemove.bind(this),this.bindMousedown=this.onmousedown.bind(this),this.bindMouseup=this.onmouseup.bind(this),this.canvas.addEventListener(\"mousedown\",this.bindMousedown),document.addEventListener(\"mouseup\",this.bindMouseup)}onmouseup(){this.isClickCanvas&&(this.isClickCanvas=!1,this.canvas.removeEventListener(\"mousemove\",this.bindMousemove),this.isMoveCanvas&&(this.isMoveCanvas=!1,this.moveCallback(\"gatherImage\"),this.gatherImage()))}onmousedown(t){this.isClickCanvas=!0,this.x=t.offsetX,this.y=t.offsetY,this.last=[this.x,this.y],this.canvas.addEventListener(\"mousemove\",this.bindMousemove)}onmousemove(t){this.isMoveCanvas=!0,this.endx=t.offsetX,this.endy=t.offsetY;let e=this.endx-this.x,i=this.endy-this.y,s=[this.endx,this.endy];switch(this.drawType){case\"line\":{let t=[this.last,s,this.lineWidth,this.drawColor];this.moveCallback(\"line\",...t),this.line(...t)}break;case\"rect\":{let t=[this.x,this.y,e,i,this.lineWidth,this.drawColor];this.moveCallback(\"rect\",t),this.rect(...t)}break;case\"polygon\":{let t=[this.x,this.y,this.sides,e,i,this.lineWidth,this.drawColor];this.moveCallback(\"polygon\",...t),this.polygon(...t)}break;case\"arc\":{let t=[this.x,this.y,e,i,this.lineWidth,this.drawColor];this.moveCallback(\"arc\",...t),this.arc(...t)}break;case\"eraser\":{let t=[this.endx,this.endy,this.width,this.height,this.lineWidth];this.moveCallback(\"eraser\",...t),this.eraser(...t)}break}}gatherImage(){this.imgData=this.imgData.slice(0,this.index+1);let t=this.paint.getImageData(0,0,this.width,this.height);this.imgData.push(t),this.index=this.imgData.length-1,this.allowCallback(this.index>0,this.index<this.imgData-1)}line(t,e,i,s){this.paint.beginPath(),this.paint.linCap=\"round\",this.paint.lineJoin=\"round\",this.paint.lineWidth=i,this.paint.strokeStyle=s,this.paint.moveTo(t[0],t[1]),this.paint.lineTo(e[0],e[1]),this.paint.closePath(),this.paint.stroke(),this.last=e}rect(t,e,i,s,a,n){this.reSetImage(),this.paint.lineWidth=a,this.paint.stokeStyle=n,this.paint.strokeRect(t,e,i,s)}reSetImage(){this.paint.clearRect(0,0,this.width,this.height),this.imgData.length>=1&&this.paint.putImageData(this.imgData[this.index],0,0)}polygon(t,e,i,s,a,n,o){this.reSetImage();let h=i,l=360/h,c=Math.sqrt(Math.pow(s,2)+Math.pow(a,2));this.paint.beginPath(),this.paint.strokeStyle=o,this.paint.lineWidth=n;for(let r=0;r<h;r++)this.paint.lineTo(t+Math.sin((r*l+45)*Math.PI/180)*c,e+Math.cos((r*l+45)*Math.PI/180)*c);this.paint.closePath(),this.paint.stroke()}arc(t,e,i,s,a,n){this.reSetImage(),this.paint.beginPath(),this.paint.lineWidth=a;let o=Math.sqrt(Math.pow(i,2)+Math.pow(s,2));this.paint.arc(t,e,o,0,2*Math.PI,!1),this.paint.strokeStyle=n,this.paint.closePath(),this.paint.stroke()}eraser(t,e,i,s,a){this.paint.save(),this.paint.beginPath(),this.paint.arc(t,e,a/2,0,2*Math.PI),this.paint.closePath(),this.paint.clip(),this.paint.clearRect(0,0,i,s),this.paint.fillStyle=\"#fff\",this.paint.fillRect(0,0,i,s),this.paint.restore()}cancel(){--this.index<0?this.index=0:(this.allowCallback(this.index>0,this.index<this.imgData.length-1),this.paint.putImageData(this.imgData[this.index],0,0))}go(){++this.index>this.imgData.length-1?this.index=this.imgData.length-1:(this.allowCallback(this.index>0,this.index<this.imgData.length-1),this.paint.putImageData(this.imgData[this.index],0,0))}clear(){this.imgData=[],this.paint.clearRect(0,0,this.width,this.height),this.paint.fillStyle=\"#fff\",this.paint.fillRect(0,0,this.width,this.height),this.gatherImage()}changeWay({type:t,color:e,lineWidth:i,sides:s}){this.drawType=\"color\"!==t&&t||this.drawType,this.drawColor=e||this.drawColor,this.lineWidth=i||this.lineWidth,this.sides=s||this.sides}destroy(){this.clear(),this.canvas.removeEventListener(\"mousedown\",this.bindMousedown),document.removeEventListener(\"mouseup\",this.bindMouseup),this.canvas=null,this.paint=null}}var h={name:\"palette\",data(){return{loading:!1,loadingText:\"呼叫中\",roomid:\"palette\",isJoin:!1,account:window.sessionStorage.account||\"\",isToPeer:!1,userList:[],isCall:!1,peer:null,offerOption:{offerToReceiveAudio:1,offerToReceiveVideo:1},handleList:[{name:\"圆\",type:\"arc\"},{name:\"线条\",type:\"line\"},{name:\"矩形\",type:\"rect\"},{name:\"多边形\",type:\"polygon\"},{name:\"橡皮擦\",type:\"eraser\"},{name:\"撤回\",type:\"cancel\"},{name:\"前进\",type:\"go\"},{name:\"清屏\",type:\"clear\"},{name:\"线宽\",type:\"lineWidth\"},{name:\"颜色\",type:\"color\"}],color:\"rgba(19, 206, 102, 1)\",currHandle:\"line\",lineWidth:5,palette:null,allowCancel:!0,allowGo:!0,sides:3,channel:null,messageList:[],sendText:\"\"}},mounted(){this.initSocket(),this.account&&this.join()},methods:{sidesChange(){this.palette.changeWay({sides:this.sides})},lineWidthChange(){this.palette.changeWay({lineWidth:this.lineWidth})},initPalette(){this.palette=new o(this.$refs[\"canvas\"],{drawColor:this.color,drawType:this.currHandle,lineWidth:this.lineWidth,allowCallback:this.allowCallback,moveCallback:this.moveCallback})},handleClick(t){if([\"cancel\",\"go\",\"clear\"].includes(t.type))return this.moveCallback(t.type),void this.palette[t.type]();this.palette.changeWay({type:t.type}),[\"color\",\"lineWidth\"].includes(t.type)||(this.currHandle=t.type)},allowCallback(t,e){this.allowCancel=!t,this.allowGo=!e},moveCallback(...t){this.send(t)},formatTime(t){const e=t.getHours(),i=t.getMinutes(),s=t.getSeconds();return[e,i,s].map(this.formatNumber).join(\":\")},formatNumber(t){return t=t.toString(),t[1]?t:\"0\"+t},send(t){if(\"text\"===t[0]){let t={account:this.account,time:this.formatTime(new Date),mes:this.sendText,type:\"text\"};this.channel.send(JSON.stringify(t)),this.messageList.push(t),this.sendText=\"\"}else this.channel.send(JSON.stringify(t))},colorChange(){this.palette.changeWay({color:this.color})},initSocket(){n[\"a\"].on(\"joined\",t=>{console.log(t,\"data\"),this.userList=t}),n[\"a\"].on(\"reply\",async t=>{switch(this.loading=!1,t.type){case\"1\":this.isCall=t.self,await this.createP2P(t),await this.createDataChannel(t),this.createOffer(t);break;case\"2\":this.$message({message:\"对方拒绝了你的请求\",type:\"warning\"});break;case\"3\":this.$message({message:\"对方正在通话中！\",type:\"warning\"});break}}),n[\"a\"].on(\"1v1ICE\",t=>{console.log(t,\"1v1ICE data----\\x3e>\"),this.onIce(t)}),n[\"a\"].on(\"apply\",t=>{console.log(t,\"data----\\x3e>>\"),this.isCall?this.reply(t.self,\"3\"):this.$confirm(t.self+\"向你请求视频通话，是否同意？\",\"提示\",{confirmButtonText:\"同意\",cancelButtonText:\"拒绝\",type:\"warning\"}).then(async()=>{await this.createP2P(t),await this.onDataChannel(),this.isCall=t.self,this.reply(t.self,\"1\")}).catch(e=>{console.error(e,\"err----\\x3e>\"),this.reply(t.self,\"2\")})}),n[\"a\"].on(\"1v1offer\",t=>{this.onOffer(t)}),n[\"a\"].on(\"1v1answer\",t=>{this.onAnswer(t)})},async onAnswer(t){try{await this.peer.setRemoteDescription(t.sdp)}catch(e){console.log(\"onAnswer：\",e)}},async onOffer(t){try{await this.peer.setRemoteDescription(t.sdp);let e=await this.peer.createAnswer();await this.peer.setLocalDescription(e),n[\"a\"].emit(\"1v1answer\",{account:t.self,self:this.account,sdp:e})}catch(e){console.log(\"onOffer： \",e)}},async createOffer(t){try{let e=await this.peer.createOffer(this.offerOption);await this.peer.setLocalDescription(e),n[\"a\"].emit(\"1v1offer\",{account:t.self,self:this.account,sdp:e})}catch(e){console.log(\"createoffer: \",e)}},initPeer(t){let e=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;this.peer=new e,this.peer.onicecandidate=e=>{e.candidate&&n[\"a\"].emit(\"1v1ICE\",{account:t.self,self:this.account,sdp:e.candidate})}},async onIce(t){try{await this.peer.addIceCandidate(t.sdp)}catch(e){console.log(\"onAnswer: \",e)}},async createP2P(t){this.loading=!0,this.loadingtext=\"正在建立通话连接\",await this.initPeer(t)},reply(t,e){n[\"a\"].emit(\"reply\",{account:t,self:this.account,type:e})},createDataChannel(){try{this.channel=this.peer.createDataChannel(\"messagechannel\"),this.handleChannel(this.channel)}catch(t){console.log(\"createChannel：\",t)}},onDataChannel(){this.peer.ondatachannel=t=>{this.channel=t.channel,this.handleChannel(this.channel)}},handleChannel(t){t.binaryType=\"arraybuffer\",t.onopen=t=>{console.log(\"channel onopen\",t),this.isToPeer=!0,this.loading=!1,this.initPalette()},t.onclose=function(t){console.log(\"channel onclose\",t)},t.onmessage=t=>{if(Array.isArray(JSON.parse(t.data))){let[e,...i]=JSON.parse(t.data);this.palette[e](...i)}else this.messageList.push(JSON.parse(t.data))}},join(){this.account&&(this.isJoin=!0,window.sessionStorage.account=this.account,n[\"a\"].emit(\"join\",{account:this.account,roomid:this.roomid}))},apply(t){this.loading=!0,this.loadingText=\"呼叫中\",console.log(\"apply, \",t,this.account),n[\"a\"].emit(\"apply\",{account:t,self:this.account})}}},l=h,c=(i(\"2add\"),i(\"2877\")),r=Object(c[\"a\"])(l,s,a,!1,null,\"cc075ba0\",null);e[\"default\"]=r.exports},\"9cc0\":function(t,e,i){}}]);","extractedComments":[]}